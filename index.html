<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ROHAN SECURITY | DEBUG MODE</title>  
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />  
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">  
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">  

<style>  
    /* SAME DESIGN */
    :root { --bg-color: #050505; --panel-bg: #0a0f14; --neon-blue: #00f3ff; --neon-red: #ff0055; --neon-green: #00ff41; --border: 1px solid rgba(0, 243, 255, 0.3); }  
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Share Tech Mono', monospace; outline: none; }  
    body { background-color: var(--bg-color); color: var(--neon-blue); height: 100vh; overflow: hidden; display: flex; }  
    #login-screen { position: fixed; inset: 0; background: black; z-index: 9999; display: flex; justify-content: center; align-items: center; }  
    .terminal-box { border: 2px solid var(--neon-blue); padding: 40px; width: 450px; text-align: center; background: #000; }  
    .hacker-input { background: transparent; border: none; border-bottom: 2px solid var(--neon-red); color: white; font-size: 1.2rem; padding: 10px; width: 100%; text-align: center; margin: 20px 0; }  
    .cyber-btn { background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 12px; width: 100%; cursor: pointer; }  
    .sidebar { width: 80px; background: var(--panel-bg); border-right: var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; }  
    .content { flex: 1; display: flex; flex-direction: column; background: #111; }  
    .nav-icon { width: 50px; height: 50px; margin-bottom: 20px; font-size: 1.4rem; color: #555; display: flex; justify-content: center; align-items: center; cursor: pointer; }
    .nav-icon.active { color: var(--neon-blue); border: var(--border); }
    .header { height: 70px; border-bottom: var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    .device-dropdown { background: black; color: var(--neon-green); border: 1px solid var(--neon-green); padding: 8px; min-width: 250px; }
    #main-app { display: none; width: 100%; height: 100%; }
    .page { display: none; padding: 25px; height: 100%; overflow-y: auto; }
    .page.active { display: block; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .cyber-card { border: var(--border); background: rgba(0,0,0,0.5); padding: 20px; }
    #map { width: 100%; height: 100%; }
</style>
</head>  
<body>  

<div id="login-screen">  
    <div class="terminal-box">  
        <h1 style="font-family:'Orbitron';">ROHAN SECURITY</h1>  
        <input type="text" id="pass-key" class="hacker-input" placeholder="ENTER LICENSE KEY">  
        <div id="login-msg" style="color:var(--neon-green); font-size:0.8rem; height:20px;"></div>
        <button onclick="checkLicense()" class="cyber-btn">CONNECT</button>  
    </div>  
</div>  

<div id="main-app">  
    <div class="sidebar">  
        <div class="nav-icon active" onclick="nav('dashboard')"><i class="fas fa-microchip"></i></div>  
        <div class="nav-icon" onclick="nav('map')"><i class="fas fa-globe-asia"></i></div>  
        <div class="nav-icon" onclick="nav('files')"><i class="fas fa-folder-open"></i></div>  
        <div class="nav-icon" onclick="nav('logs')"><i class="fas fa-database"></i></div>  
    </div>  

    <div class="content">  
        <div class="header">  
            <div style="font-family:'Orbitron'">ROHAN_SEC</div>  
            <select id="device-select" class="device-dropdown" onchange="deviceChanged()"></select>  
            <div style="color:var(--neon-green); border:1px solid var(--neon-green); padding:5px;">SECURE</div>  
        </div>  

        <div id="page-dashboard" class="page active">  
            <h2 style="color:white; margin-bottom:20px;">> STATUS_MONITOR</h2>  
            <div class="grid-3">  
                <div class="cyber-card"><h3>BATTERY</h3><h1 id="stat-bat">--%</h1></div>  
                <div class="cyber-card"><h3>STATUS</h3><h2 id="stat-status" style="color:var(--neon-green)">--</h2></div>  
                <div class="cyber-card"><h3>LAST SEEN</h3><h2 id="stat-seen">--:--</h2></div>  
            </div>  
            <div class="cyber-card" style="margin-top:20px;">
                <h3>DEBUG LOG (Error Checking)</h3>
                <div id="debug-console" style="color:yellow; font-size:0.8rem; margin-top:10px;">Waiting for connection...</div>
            </div>
        </div>  
        
        <div id="page-map" class="page"><div id="map"></div></div>
        <div id="page-files" class="page"><div class="cyber-card"><h3>FILES</h3><div id="file-list-container">Loading...</div></div></div>
        <div id="page-logs" class="page"><div class="cyber-card"><h3>SMS LOGS</h3><table id="table-sms" style="width:100%; color:#ccc;"><tbody></tbody></table></div></div>
    </div>  
</div>  

<script>  
    // --- APKA CONFIG ---
    const firebaseConfig = {  
        apiKey: "AIzaSyD7sJ0zu4cotmntqYzmaxROzwHmx8_ExvI",  
        authDomain: "children-safty.firebaseapp.com",  
        databaseURL: "https://children-safty-default-rtdb.firebaseio.com",  
        projectId: "children-safty",  
        storageBucket: "children-safty.firebasestorage.app",  
        messagingSenderId: "466811425620",  
        appId: "1:466811425620:web:7346de0e5da367adec2ec1"  
    };  
    firebase.initializeApp(firebaseConfig);  
    const db = firebase.database();  
    let map, parentLicenseKey = ""; 

    function log(msg) {
        console.log(msg);
        const d = document.getElementById('debug-console');
        if(d) d.innerHTML += "<br>> " + msg;
    }

    function checkLicense() {  
        // 1. TRIM aur UPPERCASE (Typing mistake fix)
        const key = document.getElementById('pass-key').value.trim().toUpperCase();  
        const msg = document.getElementById('login-msg');
        
        if(!key) { msg.innerText = "Enter Key"; return; }
        msg.innerText = "Checking Database...";

        db.ref('company_system/licenses/' + key).once('value', snap => {
            if(snap.exists()) {
                log("License Found: " + key);
                parentLicenseKey = key;
                document.getElementById('login-screen').style.display = 'none';  
                document.getElementById('main-app').style.display = 'flex';  
                initMap();  
                listenDevices(); 
            } else {
                msg.innerText = "Key Not Found in DB!";
                log("Error: Key " + key + " does not exist.");
            }
        });
    }  

    function listenDevices() {
        const sel = document.getElementById('device-select');
        sel.innerHTML = '<option>SCANNING...</option>';
        log("Scanning for devices on key: " + parentLicenseKey);

        db.ref('company_system/licenses/' + parentLicenseKey).on('value', licenseSnap => {
            const licenseData = licenseSnap.val();
            let deviceIds = [];

            // Method A: Old
            if (licenseData.adminDeviceId) {
                deviceIds.push(licenseData.adminDeviceId);
                log("Found Single Device: " + licenseData.adminDeviceId);
            }
            // Method B: New List
            if (licenseData.devices) {
                Object.keys(licenseData.devices).forEach(id => {
                    if(!deviceIds.includes(id)) deviceIds.push(id);
                });
                log("Found Device List: " + JSON.stringify(deviceIds));
            }

            if (deviceIds.length === 0) {
                sel.innerHTML = '<option>NO DEVICES FOUND</option>';
                document.getElementById('stat-status').innerText = "PENDING CONNECTION";
                log("License exists but NO DEVICES linked. Please login in User App.");
                return;
            }

            sel.innerHTML = ''; 
            
            deviceIds.forEach(targetId => {
                log("Checking Data for Device: " + targetId);
                
                db.ref('users/' + targetId).on('value', userSnap => {
                    if(!userSnap.exists()) {
                        log("⚠️ Device " + targetId + " linked, BUT NO DATA in 'users' folder.");
                    } else {
                        log("✅ Data Received for: " + targetId);
                    }

                    // STRICT MODE HATA DIYA HAI (Dikhna chahiye chahe data ho ya na ho)
                    const d = userSnap.val() || {};
                    const name = d.info?.name || targetId;
                    
                    let existingOpt = sel.querySelector(`option[value="${targetId}"]`);
                    if (!existingOpt) {
                        let opt = document.createElement('option');
                        opt.value = targetId;
                        opt.text = `${name} [CONNECTED]`;
                        sel.add(opt);
                    }
                    
                    // Auto select
                    if(sel.value === targetId) deviceChanged();
                });
            });
        });
    }

    function deviceChanged() {
        const id = document.getElementById('device-select').value;
        if(!id) return;
        
        db.ref('users/' + id).on('value', snap => {
            const d = snap.val() || {};
            document.getElementById('stat-bat').innerText = (d.info?.battery || 0) + "%";
            document.getElementById('stat-status').innerText = d.info?.status || "WAITING";
            document.getElementById('stat-seen').innerText = new Date(d.info?.lastSeen || Date.now()).toLocaleTimeString();
            
            if(d.location?.latitude && map) {
                map.setView([d.location.latitude, d.location.longitude], 15);
                L.marker([d.location.latitude, d.location.longitude]).addTo(map).bindPopup("Target").openPopup();
            }
            
            // SMS Render
            const tbody = document.getElementById('table-sms').querySelector('tbody');
            tbody.innerHTML = '';
            if(d.logs?.sms) {
                Object.values(d.logs.sms).forEach(s => {
                    tbody.innerHTML += `<tr><td>${s.sender}</td><td>${s.msg}</td><td>${new Date(s.time).toLocaleTimeString()}</td></tr>`;
                });
            }
        });
    }

    function nav(page) {
        document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
        document.getElementById('page-'+page).classList.add('active');
        if(page==='map' && map) setTimeout(()=>map.invalidateSize(), 300);
    }

    function initMap() { 
        if(document.getElementById('map')) {
            map = L.map('map').setView([20, 78], 4); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 
        }
    }
</script>
</body>  
</html>
